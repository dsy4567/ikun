<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="UTF-8" />
        <!-- Copyright (c) 2023 dsy4567, view license at <https://github.com/dsy4567/ikun/blob/main/LICENSE> -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ikun 专属乐器</title>
        <style>
            @keyframes octocat-wave {
                0%,
                100% {
                    transform: rotate(0);
                }
                20%,
                60% {
                    transform: rotate(-25deg);
                }
                40%,
                80% {
                    transform: rotate(10deg);
                }
            }
            @media (max-width: 500px) {
                .github-corner:hover .octo-arm {
                    animation: none;
                }
                .github-corner .octo-arm {
                    animation: octocat-wave 560ms ease-in-out;
                }
            }
            html {
                color-scheme: light dark;
            }
            .github-corner:hover .octo-arm {
                animation: octocat-wave 560ms ease-in-out;
            }
            button[data-note] {
                width: 36px;
            }
            input:invalid {
                background-color: red;
            }
        </style>
    </head>
    <body>
        <a
            href="https://github.com/dsy4567/ikun"
            class="github-corner"
            aria-label="View source on GitHub"
            ><svg
                width="80"
                height="80"
                viewBox="0 0 250 250"
                style="fill: #333; color: #fff; position: absolute; top: 0; border: 0; right: 0"
                aria-hidden="true"
            >
                <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                <path
                    d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                    fill="currentColor"
                    style="transform-origin: 130px 106px"
                    class="octo-arm"
                ></path>
                <path
                    d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                    fill="currentColor"
                    class="octo-body"
                ></path>
            </svg>
        </a>
        <h1>ikun 专属乐器</h1>
        <img src="jntm.jpg" alt="kun" />
        <hr />
        <button data-note="+1">+1</button>
        <button data-note="+2">+2</button>
        <button data-note="+3">+3</button>
        <button data-note="+4">+4</button>
        <button data-note="+5">+5</button>
        <button data-note="+6">+6</button>
        <button data-note="+7">+7</button>
        <br /><br />
        <button data-note="1">1</button>
        <button data-note="2">2</button>
        <button data-note="3">3</button>
        <button data-note="4">4</button>
        <button data-note="5">5</button>
        <button data-note="6">6</button>
        <button data-note="7">7</button>
        <button data-note="0">啊</button>
        <br /><br />
        <button data-note="-1">-1</button>
        <button data-note="-2">-2</button>
        <button data-note="-3">-3</button>
        <button data-note="-4">-4</button>
        <button data-note="-5">-5</button>
        <button data-note="-6">-6</button>
        <button data-note="-7">-7</button>
        <hr />
        <textarea
            id="曲谱"
            style="width: 100%; height: 114.514px"
            placeholder="曲谱, 使用空格分隔, ~n 可以停顿演奏 n 个音符时长, 换行符及多个连续空格将被忽略"
        ></textarea>
        <br />
        <button id="演奏">演奏</button>
        <button onclick="演奏.onclick(曲谱.value.substring(曲谱.selectionStart,曲谱.selectionEnd))">
            演奏选中
        </button>
        <button id="停止">停止</button>
        <br />
        <button onclick="曲谱.value+=' '">空格</button>
        <button onclick="曲谱.value+='\n ~' + sl.value">换行 + 停顿</button>
        <button onclick="曲谱.value=曲谱.value.substring(0, 曲谱.value.lastIndexOf(' '))">
            删除
        </button>
        <button onclick="曲谱.value+=` ~${sl.value}`">停顿 n 个音符时长:</button>
        <input id="sl" placeholder="n" value="1" step="0.1" type="number" />
        <label>
            <input checked type="checkbox" id="编谱模式" />
            记录音符
        </label>
        <br />
        <label>
            每个音符间隔(毫秒)
            <input value="300" type="number" min="0" step="50" id="timeout" />
        </label>
        <br />
        <label>
            URL
            <input
                type="url"
                id="bgm"
                placeholder="url"
                value="https://music.163.com/song/media/outer/url?id=114514.mp3"
            />
        </label>
        <button onclick="曲谱.value='!bgm:'+document.querySelector('#bgm').value+'\n'+曲谱.value">
            添加背景阴乐
        </button>
        <br />
        <label>
            注释
            <input type="text" id="comment" />
        </label>
        <button onclick="曲谱.value+=' // ' + comment.value + '\n '">添加注释</button>
        <br />
        <button>如果浏览器偷懒，请疯狂点击此按钮, 以保持交互状态, 让浏览器两刻半也不敢放松</button>
        <hr />
        <div>
            <span>示例曲谱</span><br />
            <button data-name="两只老虎">两只老虎</button>
            <button data-name="小星星">小星星</button>
            <button data-name="玛丽的小羊羔">玛丽的小羊羔</button>
            <button data-name="让风告诉你">让风告诉你</button>
        </div>
        <br />
        <span>Made with ♥ by <a href="https://github.com/dsy4567">dsy4567</a></span>
        <script>
            const /** @type {HTMLInputElement} */ 曲谱 = document.getElementById("曲谱"),
                /** @type {HTMLInputElement} */ 编谱模式 = document.getElementById("编谱模式"),
                /** @type {HTMLButtonElement} */ 演奏 = document.getElementById("演奏"),
                /** @type {HTMLInputElement} */ 停止 = document.getElementById("停止"),
                /** @type {Record<string, HTMLAudioElement>} */ audio = {};
            let timeouts = [],
                selectionStart = 0,
                selectionEnd = 0,
                selectionDirection = "forward",
                正在演奏 = false;
            document.querySelectorAll("button[data-note]").forEach(async el => {
                audio[el.dataset.note] = URL.createObjectURL(
                    await (await fetch(`audio/${el.dataset.note}.mp3`)).blob()
                );
                el.onmousedown = () => {
                    new Audio(audio[el.dataset.note]).play();
                };
                el.onclick = () => {
                    if (编谱模式.checked) {
                        曲谱.value += " " + el.dataset.note;
                    }
                };
            });
            演奏.onclick = 演奏选中 => {
                if (正在演奏) return;
                正在演奏 = true;
                selectionStart = 曲谱.selectionStart;
                selectionEnd = 曲谱.selectionEnd;
                selectionDirection = 曲谱.selectionDirection;
                曲谱.readOnly = true;
                曲谱.focus();
                let index = typeof 演奏选中 === "string" ? 曲谱.selectionStart : 0,
                    n = 0,
                    bgmUrl = "",
                    /** @type {string} */ p = typeof 演奏选中 === "string" ? 演奏选中 : 曲谱.value;
                曲谱.setSelectionRange(0, 0);
                const f = () => {
                    p.replace(/(\n| +\/\/.+\n)/g, " ")
                        .replace(/ +/g, " ")
                        .split(" ")
                        .forEach(s => {
                            let sleep = 0;
                            if (s.startsWith("~")) {
                                sleep = +s.replace("~", "");
                                if (isNaN(sleep)) sleep = 1;
                                return (n += sleep);
                            }
                            timeouts.push(
                                setTimeout(() => {
                                    new Audio(audio[s]).play();
                                    const start = 曲谱.value.indexOf(s, index),
                                        end = start + s.length;
                                    曲谱.setSelectionRange(start, end);
                                    index = end;
                                }, +timeout.value * n++)
                            );
                        });
                    timeouts.push(
                        setTimeout(() => {
                            停止.click(1);
                        }, +timeout.value * n)
                    );
                };
                if (p.startsWith("!bgm:")) {
                    let m = p.match(/\!bgm\:.+\n/);
                    bgmUrl = m[0].replace("!bgm:", "").replace("\n", "");
                    p = p.replace(m[0], "");
                }
                if (bgmUrl) {
                    let bgm = new Audio(bgmUrl);
                    bgm.preload = "auto";
                    bgmUrl = "";
                    bgm.onloadedmetadata = () => {
                        bgm.play();
                        f();
                    };
                } else f();
            };
            停止.onclick = ct => {
                if (ct !== 1) for (const t of timeouts) clearTimeout(t);
                timeouts = [];
                正在演奏 = false;
                曲谱.readOnly = false;
                曲谱.focus()
                曲谱.setSelectionRange(selectionStart, selectionEnd, selectionDirection);
            };
            document.querySelectorAll("button[data-name]").forEach(el => {
                el.onclick = () => {
                    fetch(`example/${el.dataset.name}.txt`).then(async res => {
                        曲谱.value = await res.text();
                    });
                };
            });
        </script>
    </body>
</html>
